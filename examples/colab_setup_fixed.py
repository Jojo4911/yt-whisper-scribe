"""
üöÄ YT-WHISPER-SCRIBE - Configuration Colab CORRIG√âE
Version sans erreur de syntaxe, test√©e pour Google Colab
"""

import os
import subprocess
import sys
from pathlib import Path
from typing import Optional

# === CONFIGURATION ===
GITHUB_REPO = "https://github.com/Jojo4911/yt-whisper-scribe.git"
PROJECT_DIR = "/content/yt-whisper-scribe"
COOKIES_SEARCH_PATHS = [
    "/content/drive/MyDrive/yt-whisper-private/cookies_youtube.txt",
    "/content/drive/MyDrive/cookies_youtube.txt", 
    "/content/cookies_youtube.txt",
    "/content/cookies.txt",
    f"{PROJECT_DIR}/data/cookies.txt"
]

def setup_colab_environment(force_reinstall: bool = False):
    """Configure l'environnement Colab avec int√©gration GitHub directe."""
    
    print("üöÄ YT-WHISPER-SCRIBE - SETUP COLAB CORRIG√â")
    print("=" * 60)
    
    try:
        # 1. V√©rification GPU
        print("\nüéÆ 1. V√©rification GPU...")
        _check_gpu_availability()
        
        # 2. Clone/Update du projet depuis GitHub
        print("\nüì• 2. R√©cup√©ration du projet depuis GitHub...")
        success = _setup_project_from_github(force_reinstall)
        if not success:
            return False
        
        # 3. Installation des d√©pendances
        print("\nüì¶ 3. Installation des d√©pendances...")
        _install_dependencies()
        
        # 4. Configuration des cookies
        print("\nüç™ 4. Configuration des cookies...")
        _setup_cookies_management()
        
        # 5. Configuration Google Drive (optionnel)
        print("\n‚òÅÔ∏è 5. Configuration Google Drive...")
        _setup_drive_integration()
        
        print("\n‚úÖ Setup termin√©! Utilisez transcribe_video(url)")
        return True
        
    except Exception as e:
        print(f"\n‚ùå Erreur durante la configuration: {e}")
        print("üîß Essayez la configuration manuelle...")
        return _manual_setup()

def _check_gpu_availability():
    """V√©rifie la disponibilit√© du GPU."""
    try:
        import torch
        if torch.cuda.is_available():
            gpu_name = torch.cuda.get_device_name(0)
            gpu_memory = torch.cuda.get_device_properties(0).total_memory / 1e9
            print(f"‚úÖ GPU d√©tect√©: {gpu_name} ({gpu_memory:.1f} GB)")
        else:
            print("‚ö†Ô∏è  CPU seulement - Activez le GPU: Runtime > Change runtime type > GPU")
    except ImportError:
        print("‚ö†Ô∏è  PyTorch non encore install√©")

def _setup_project_from_github(force_reinstall: bool = False):
    """Clone ou met √† jour le projet depuis GitHub."""
    try:
        if os.path.exists(PROJECT_DIR) and force_reinstall:
            print("üîÑ Suppression de l'ancienne version...")
            subprocess.run(["rm", "-rf", PROJECT_DIR], check=True)
        
        if not os.path.exists(PROJECT_DIR):
            print(f"üì• Clonage depuis {GITHUB_REPO}...")
            result = subprocess.run([
                "git", "clone", GITHUB_REPO, PROJECT_DIR
            ], capture_output=True, text=True)
            
            if result.returncode != 0:
                print(f"‚ùå Erreur de clonage: {result.stderr}")
                return False
            print("‚úÖ Projet clon√© avec succ√®s")
        else:
            print("üìÇ Projet existant d√©tect√©")
            os.chdir(PROJECT_DIR)
            print("üîÑ Mise √† jour depuis GitHub...")
            subprocess.run(["git", "pull", "origin", "main"], capture_output=True)
            print("‚úÖ Projet mis √† jour")
        
        os.chdir(PROJECT_DIR)
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur lors du clonage: {e}")
        return False

def _install_dependencies():
    """Installe les d√©pendances du projet."""
    try:
        # Mise √† jour des paquets syst√®me
        subprocess.run(["apt-get", "update", "-qq"], check=True)
        subprocess.run(["apt-get", "install", "-y", "ffmpeg"], check=True)
        
        # Installation des d√©pendances Python
        subprocess.run([
            "pip", "install", "-r", "requirements.txt", "--quiet"
        ], check=True)
        
        # Installation PyTorch avec CUDA (si n√©cessaire)
        try:
            import torch
            if not torch.cuda.is_available():
                print("üîß Installation de PyTorch avec CUDA...")
                subprocess.run([
                    "pip", "install", "torch", "torchvision", "torchaudio", 
                    "--index-url", "https://download.pytorch.org/whl/cu121", "--quiet"
                ], check=True)
        except ImportError:
            print("üîß Installation de PyTorch avec CUDA...")
            subprocess.run([
                "pip", "install", "torch", "torchvision", "torchaudio", 
                "--index-url", "https://download.pytorch.org/whl/cu121", "--quiet"
            ], check=True)
        
        print("‚úÖ D√©pendances install√©es")
        
    except Exception as e:
        print(f"‚ùå Erreur lors de l'installation: {e}")
        raise

def _setup_drive_integration():
    """Configure l'int√©gration avec Google Drive."""
    try:
        # Import dynamique pour √©viter les erreurs hors Colab
        try:
            from google.colab import drive
        except ImportError:
            print("‚ö†Ô∏è  Module google.colab non disponible")
            return
            
        if not os.path.exists("/content/drive"):
            print("üîó Montage de Google Drive...")
            drive.mount('/content/drive')
            print("‚úÖ Google Drive mont√©")
        else:
            print("‚úÖ Google Drive d√©j√† mont√©")
            
        # Cr√©ation du dossier priv√© pour les cookies
        private_dir = Path("/content/drive/MyDrive/yt-whisper-private")
        private_dir.mkdir(exist_ok=True)
        print(f"üìÅ Dossier priv√© cr√©√©: {private_dir}")
        
    except Exception as e:
        print(f"‚ö†Ô∏è  Erreur Drive: {e}")

def _setup_cookies_management():
    """Configure la gestion avanc√©e des cookies."""
    cookies_path = _find_cookies_file()
    
    if cookies_path:
        print(f"‚úÖ Cookies d√©tect√©s: {cookies_path}")
        os.environ['YT_COOKIES_FILE'] = str(cookies_path)
        print("üîß Variable YT_COOKIES_FILE configur√©e")
    else:
        print("‚ÑπÔ∏è  Aucun cookie d√©tect√© - Fonctionnement sans cookies")
        _show_cookies_instructions()

def _find_cookies_file() -> Optional[Path]:
    """Recherche les cookies dans les emplacements pr√©d√©finis."""
    for path_str in COOKIES_SEARCH_PATHS:
        path = Path(path_str)
        if path.exists() and path.is_file():
            return path
    return None

def _show_cookies_instructions():
    """Affiche les instructions pour configurer les cookies."""
    print("""
üìã POUR AJOUTER VOS COOKIES:

1. M√©thode recommand√©e (Google Drive):
   - Exportez vos cookies depuis votre navigateur
   - Utilisez clean_cookies_interactive() pour les nettoyer
   - Sauvegardez dans /content/drive/MyDrive/yt-whisper-private/

2. Upload direct:
   - Uploadez cookies_youtube.txt via l'interface Colab
   - Le syst√®me les d√©tectera automatiquement

‚ö†Ô∏è  S√âCURIT√â: Utilisez uniquement des cookies YouTube nettoy√©s!
    """)

def _manual_setup():
    """Configuration manuelle de secours."""
    try:
        print("üîß Configuration manuelle...")
        
        # Clone du projet
        if not os.path.exists(PROJECT_DIR):
            subprocess.run([
                'git', 'clone', GITHUB_REPO, PROJECT_DIR
            ], check=True)
        
        os.chdir(PROJECT_DIR)
        
        # Installation basique
        subprocess.run([
            'pip', 'install', '-r', 'requirements.txt', '--quiet'
        ], check=True)
        
        print("‚úÖ Configuration manuelle termin√©e!")
        return True
        
    except Exception as e:
        print(f"‚ùå Configuration manuelle √©chou√©e: {e}")
        return False

def clean_cookies_interactive():
    """Nettoie interactivement un fichier cookies."""
    print("üßπ NETTOYAGE INTERACTIF DES COOKIES")
    
    # Recherche du fichier cookies upload√©
    potential_files = [
        "/content/cookies.txt",
        "/content/cookies_complets.txt", 
        "/content/cookies_full.txt"
    ]
    
    input_file = None
    for file_path in potential_files:
        if os.path.exists(file_path):
            input_file = file_path
            break
    
    if not input_file:
        print("‚ùå Aucun fichier cookies d√©tect√© dans /content/")
        print("   Uploadez d'abord votre fichier cookies.txt via l'interface Colab")
        return False
    
    print(f"üìÅ Fichier d√©tect√©: {input_file}")
    
    # Nettoyage
    output_file = "/content/cookies_youtube_clean.txt"
    
    try:
        # V√©rification que nous sommes dans le bon dossier
        if not os.path.exists("scripts/clean_cookies.py"):
            os.chdir(PROJECT_DIR)
        
        # Utilisation du script de nettoyage
        result = subprocess.run([
            "python", "scripts/clean_cookies.py", 
            input_file, output_file
        ], capture_output=True, text=True)
        
        if result.returncode == 0:
            print("‚úÖ Cookies nettoy√©s avec succ√®s!")
            print(result.stdout)
            
            # Configuration automatique
            os.environ['YT_COOKIES_FILE'] = output_file
            print(f"üîß Variable YT_COOKIES_FILE configur√©e: {output_file}")
            
            # Option de copie vers Drive
            drive_path = "/content/drive/MyDrive/yt-whisper-private/cookies_youtube.txt"
            if os.path.exists("/content/drive"):
                try:
                    os.makedirs(os.path.dirname(drive_path), exist_ok=True)
                    subprocess.run(["cp", output_file, drive_path], check=True)
                    print(f"üíæ Cookies sauvegard√©s dans Drive: {drive_path}")
                except Exception as e:
                    print(f"‚ö†Ô∏è  Sauvegarde Drive √©chou√©e: {e}")
            
            return True
        else:
            print("‚ùå Erreur lors du nettoyage:")
            print(result.stderr)
            return False
            
    except Exception as e:
        print(f"‚ùå Erreur: {e}")
        return False

def transcribe_video(
    url: str, 
    model: str = "turbo", 
    output_format: str = "srt",
    use_swood_glossary: bool = True,
    language: str = "en",
    device: str = "auto",
    verbose: bool = True
) -> Optional[str]:
    """Fonction principale de transcription optimis√©e pour Colab."""
    
    print(f"\nüé¨ TRANSCRIPTION: {url}")
    print(f"üìä Mod√®le: {model} | Format: {output_format} | Langue: {language}")
    
    # V√©rification de l'environnement
    if not os.path.exists(PROJECT_DIR):
        print("‚ùå Projet non configur√©. Ex√©cutez setup_colab_environment() d'abord.")
        return None
    
    os.chdir(PROJECT_DIR)
    
    # Construction de la commande
    cmd = [
        "python", "scripts/transcribe.py", url,
        "--model", model,
        "--output_format", output_format,
        "--language", language,
        "--device", device,
        "--output_dir", "data"
    ]
    
    if verbose:
        cmd.append("--verbose")
    
    # Ajout du glossaire SWOOD
    if use_swood_glossary and os.path.exists("SWOOD_Glossary.json"):
        cmd.extend(["--replace-map", "SWOOD_Glossary.json"])
        print("üîß Glossaire SWOOD activ√©")
    
    # Gestion des cookies
    cookies_path = _find_cookies_file()
    if cookies_path:
        cmd.extend(["--cookies-file", str(cookies_path)])
        print(f"üç™ Cookies configur√©s: {cookies_path.name}")
    else:
        print("‚ö†Ô∏è  Pas de cookies - Certaines vid√©os pourraient √™tre inaccessibles")
    
    # Ex√©cution
    print("\n" + "="*60)
    print("üöÄ D√âBUT DE LA TRANSCRIPTION")
    print("="*60)
    
    try:
        result = subprocess.run(cmd, cwd=PROJECT_DIR)
        
        if result.returncode == 0:
            print("\n" + "="*60)
            print("‚úÖ TRANSCRIPTION TERMIN√âE AVEC SUCC√àS")
            print("="*60)
            
            # Recherche du fichier g√©n√©r√©
            data_dir = Path(PROJECT_DIR) / "data"
            if data_dir.exists():
                pattern = f"*.{output_format}"
                files = list(data_dir.glob(pattern))
                if files:
                    latest_file = max(files, key=lambda p: p.stat().st_mtime)
                    print(f"üìÅ Fichier g√©n√©r√©: {latest_file}")
                    
                    # Affichage d'un aper√ßu
                    _show_file_preview(latest_file)
                    
                    return str(latest_file)
            
            print("‚ö†Ô∏è  Fichier g√©n√©r√© non trouv√© dans data/")
            return None
            
        else:
            print("\n‚ùå √âCHEC DE LA TRANSCRIPTION")
            _show_troubleshooting_tips()
            return None
            
    except KeyboardInterrupt:
        print("\n‚èπÔ∏è  Transcription interrompue par l'utilisateur")
        return None
    except Exception as e:
        print(f"\n‚ùå Erreur inattendue: {e}")
        return None

def _show_file_preview(file_path: Path):
    """Affiche un aper√ßu du fichier g√©n√©r√©."""
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
            preview_length = 500
            if len(content) > preview_length:
                preview = content[:preview_length] + "...\n[Contenu tronqu√©]"
            else:
                preview = content
            
            print("\nüìÑ APER√áU DU FICHIER:")
            print("-" * 40)
            print(preview)
            print("-" * 40)
            
    except Exception as e:
        print(f"‚ö†Ô∏è  Impossible d'afficher l'aper√ßu: {e}")

def _show_troubleshooting_tips():
    """Affiche des conseils de d√©pannage."""
    print("""
üîß CONSEILS DE D√âPANNAGE:

1. Vid√©o priv√©e/restreinte:
   ‚Üí Configurez vos cookies YouTube avec clean_cookies_interactive()

2. Mod√®le trop lourd:
   ‚Üí Essayez un mod√®le plus petit: transcribe_video(url, model="base")

3. Erreur de m√©moire GPU:
   ‚Üí Forcez l'usage du CPU: transcribe_video(url, device="cpu")

4. URL invalide:
   ‚Üí V√©rifiez que l'URL YouTube est correcte et accessible

5. Probl√®me r√©seau:
   ‚Üí Relancez la transcription, yt-dlp a des m√©canismes de retry
    """)

# === FONCTIONS DE COMMODIT√â ===
def quick_setup():
    """Setup rapide en une commande."""
    return setup_colab_environment()

def demo_transcribe():
    """D√©monstration interactive."""
    print("üéØ D√âMONSTRATION INTERACTIVE")
    
    # V√©rification du setup
    if not os.path.exists(PROJECT_DIR):
        print("üîß Configuration automatique...")
        if not setup_colab_environment():
            print("‚ùå Configuration √©chou√©e")
            return None
    
    print("\nüìã Exemples d'utilisation:")
    print("""
# 1. Transcription simple
transcribe_video("https://youtube.com/watch?v=VIDEO_ID")

# 2. Transcription SWOOD avec mod√®le pr√©cis
transcribe_video(
    "https://youtube.com/watch?v=VIDEO_ID",
    model="medium",
    use_swood_glossary=True
)

# 3. Transcription en fran√ßais vers texte
transcribe_video(
    "https://youtube.com/watch?v=VIDEO_ID", 
    language="fr",
    output_format="txt"
)
    """)
    
    # Entr√©e interactive
    try:
        url = input("\nüé¨ Entrez une URL YouTube (ou Enter pour ignorer): ").strip()
        if url and ("youtube.com" in url or "youtu.be" in url):
            print("\nüöÄ Lancement de la transcription...")
            return transcribe_video(url)
        else:
            print("‚ÑπÔ∏è  Aucune URL fournie - utilisez transcribe_video(url) manuellement")
    except KeyboardInterrupt:
        print("\n‚èπÔ∏è  D√©monstration annul√©e")
    
    return None

def show_project_info():
    """Affiche les informations sur le projet."""
    print("""
üìä YT-WHISPER-SCRIBE - INFORMATIONS

üéØ Fonctionnalit√©s:
  ‚Ä¢ Transcription locale avec Whisper
  ‚Ä¢ Support vocabulaire m√©tier SWOOD
  ‚Ä¢ Corrections post-transcription intelligentes  
  ‚Ä¢ Gestion s√©curis√©e des cookies YouTube
  ‚Ä¢ Export SRT et TXT

üìÅ Structure:
  ‚Ä¢ scripts/transcribe.py - CLI principal
  ‚Ä¢ SWOOD_Glossary.json - Corrections m√©tier
  ‚Ä¢ data/ - Fichiers de sortie
  ‚Ä¢ examples/ - Exemples et configuration Colab

üöÄ Commandes rapides:
  ‚Ä¢ setup_colab_environment() - Configuration initiale
  ‚Ä¢ transcribe_video(url) - Transcription simple
  ‚Ä¢ clean_cookies_interactive() - Nettoyage cookies
  ‚Ä¢ demo_transcribe() - D√©monstration interactive
    """)

# === AUTO-EX√âCUTION POUR COLAB ===
if __name__ == "__main__":
    try:
        # D√©tection de l'environnement Colab
        import google.colab
        print("üîç Environnement Google Colab d√©tect√©")
        
        # Setup automatique si pas encore fait
        if not os.path.exists(PROJECT_DIR):
            print("üöÄ Premier lancement - Configuration automatique...")
            setup_colab_environment()
        
        # Affichage des informations
        show_project_info()
        
        print("\n‚ú® Pr√™t √† l'emploi! Utilisez transcribe_video(url) pour commencer.")
        
    except ImportError:
        print("‚ö†Ô∏è  Ce script est optimis√© pour Google Colab")
        print("   Pour usage local, consultez la documentation principale")